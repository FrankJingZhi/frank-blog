---
title: 04å¼•å…¥å‡½æ•°ç»„ä»¶ä¸ç±»ç»„ä»¶æå‡æ¸²æŸ“èƒ½åŠ›â€”â€”å®ç°äº‹ä»¶å§”æ‰˜æœºåˆ¶
date: 2024-01-11 19:37:09
tags: [React]
categories: [ä»0åˆ°1å®ç°Reactæ ¸å¿ƒåŠŸèƒ½]
---

# å‰è¨€

> è¿™æ˜¯`React`çš„æ·±åº¦å­¦ä¹ ç³»åˆ—çš„ç¬¬äºŒç¯‡ï¼Œè¿™ä¸ªç³»åˆ—æ˜¯é€šè¿‡ä» 0 åˆ° 1 ä¸€æ­¥æ­¥æ‰‹å†™`React`å®ç°è‡ªå·±çš„`mini-react`ï¼Œä»¥æ­¤æ¥è¾¾åˆ°é˜…è¯»æºç ã€å­¦ä¹ æºç çš„ç›®çš„ã€‚

> PSï¼šæœ¬ç« èŠ‚å®ç°çš„å†…å®¹ä¸ºç±»ç»„ä»¶ç‰ˆæœ¬çš„ Reactï¼Œå‡½æ•°ç»„ä»¶ç‰ˆæœ¬çš„ä¼šåœ¨åç»­ç« èŠ‚ä¸­å®ç° ğŸŒŸ

æœ¬ç« èŠ‚æˆ‘ä»¬ä¸»è¦å®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š

1. åˆ†æäº‹ä»¶å§”æ‰˜æœºåˆ¶çš„åŸç†
2. å®ç°äº‹ä»¶å§”æ‰˜æœºåˆ¶

# æ­£æ–‡

## åˆ†æäº‹ä»¶å§”æ‰˜æœºåˆ¶çš„åŸç†

### ä¸ºä»€ä¹ˆéœ€è¦äº‹ä»¶å§”æ‰˜æœºåˆ¶

1. æµè§ˆå™¨çš„ç‰ˆæœ¬æ˜¯å±‚å‡ºä¸ç©·ï¼Œè¿˜æœ‰åƒ IE6ï¼Œ7ï¼Œ8 è¿™ç§æ€ªèƒã€‚è¿™äº›æµè§ˆå™¨æŠ›å‡ºçš„ api å¯èƒ½éƒ½ä¼šæœ‰å·®å¼‚ï¼Œæ¯”å¦‚

- äº‹ä»¶æºä¸åŒï¼šä¸€èˆ¬æµè§ˆå™¨ä¸­æ˜¯`event.target`, IE6ï¼Œ7ï¼Œ8 ä¸­æ˜¯`event.srcElement`
- é˜»æ­¢å†’æ³¡çš„æ–¹å¼ä¸åŒï¼šä¸€èˆ¬æµè§ˆå™¨ä¸­æ˜¯`stopProppagation()`ï¼ŒIE6ï¼Œ7ï¼Œ8 ä¸­æ˜¯`this.event.cancelBubble = true`
- é˜»æ­¢é»˜è®¤è¡Œä¸ºä¸åŒï¼šä¸€èˆ¬æµè§ˆå™¨ä¸­æ˜¯`preventDefault()`ï¼ŒIE6ï¼Œ7ï¼Œ8 ä¸­æ˜¯`this.event.returnValue = false`

  è¿™äº›æƒ…å†µéƒ½éœ€è¦å…¼å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦å¯¹è¿™äº›äº‹ä»¶åšä¸€å±‚å°è£…ï¼Œæ¥æŠ¹å¹³è¿™äº›å·®å¼‚ã€‚

2. æœ‰äº›æ“ä½œä¼šå¾ˆå¤æ‚ï¼Œå†…å­˜å¼€é”€ä¼šå¾ˆå¤§

   æ¯”å¦‚ï¼Œæœ‰ä¸€ä¸ª 1000 æ¡çš„åˆ—è¡¨ï¼Œæ¯ä¸ªåˆ—è¡¨é¡¹éƒ½ç»‘å®šäº†äº‹ä»¶ï¼Œå¹¶ä¸”è¿™äº›åˆ—è¡¨é¡¹è¿˜æ¶‰åŠå¢åˆ æ”¹æŸ¥ç­‰æ“ä½œã€‚

   è¿™ç§æƒ…å†µï¼Œå¦‚æœæˆ‘ä»¬æ¯ä¸ªè¡¨å•é¡¹çš„äº‹ä»¶éƒ½å»å¤„ç†ï¼Œé‚£ä¹ˆå°±ä¼šå¾ˆå¤æ‚ï¼Œå†…å­˜å¼€é”€ä¼šå¾ˆå¤§ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹è¿™äº›äº‹ä»¶åšä¸€å±‚å°è£…ï¼Œæ¥å‡å°å†…å­˜å¼€é”€

### React ä¸­çš„äº‹ä»¶å§”æ‰˜æœºåˆ¶

é‚£ React æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ

æˆ‘ä»¬æ¥çœ‹è¿™ä¸€å¼ å›¾

![](/images/mini-react-04-event.png)

è¿™å¼ å›¾æ˜¯æˆ‘ä»¬çš„äº‹ä»¶ä»æ•è·åˆ°å†’æ³¡çš„è¿‡ç¨‹ã€‚ä»å›¾ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬ç»‘å®šåœ¨å…ƒç´ ä¸Šçš„æ‰€æœ‰äº‹ä»¶éƒ½ä¼šä» document å¼€å§‹`ç”±å¤–å‘å†…`ä¸€å±‚å±‚æ•è·ï¼Œç›´åˆ°äº‹ä»¶ç»‘å®šçš„å…ƒç´ ï¼Œç„¶åå†ä»è¯¥å…ƒç´ å¼€å§‹`ç”±å†…å‘å¤–`ä¸€å±‚å±‚å†’æ³¡ï¼Œç›´åˆ° documentã€‚

å› ä¸ºæ‰€æœ‰çš„äº‹ä»¶æœ€ç»ˆéƒ½ä¼šå†’æ³¡åˆ° document ä¸Šï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥å°†æ‰€æœ‰äº‹ä»¶éƒ½å§”æ‰˜åˆ° document ä¸Šï¼Œç„¶åå°†è¿™äº›äº‹ä»¶å’Œå…ƒç´ åšå¥½æ˜ å°„ï¼Œç„¶ååªç›‘å¬è¿™ä¸€ä¸ªå…ƒç´ å°±å¯ä»¥äº†ã€‚

é‚£æˆ‘ä»¬éœ€è¦åšçš„å°±ä¸‰ä»¶äº‹æƒ…ï¼š

1. å°†äº‹ä»¶ã€å…ƒç´ å’Œç»‘å®šçš„å›è°ƒå‡½æ•°åšå¥½æ˜ å°„
2. å°†äº‹ä»¶éƒ½å§”æ‰˜åˆ° document ä¸Š
3. æŠ¹å¹³æµè§ˆå™¨ä¹‹é—´çš„å·®å¼‚

## å®ç°äº‹ä»¶å§”æ‰˜æœºåˆ¶

è¿˜è®°å¾—æˆ‘ä»¬åœ¨ç¬¬ä¸€èŠ‚ä¸­å¤„ç†å±æ€§æ—¶ç•™ä¸‹çš„é‚£ä¸ª TODO å—ï¼Ÿ

```js
// å¤„ç†å±æ€§
function setPropsFromDOM(dom, VNodeProps = {}) {
  if (!VNodeProps) return
  for (let key in VNodeProps) {
    if (key === 'children') continue
    if (key === 'style') {
      for (let styleKey in VNodeProps.style) {
        dom.style[styleKey] = VNodeProps.style[styleKey]
      }
    } else if (/^on[A-Z].*/.test(key)) {
      // TODOï¼šå¤„ç†äº‹ä»¶
    } else {
      dom[key] = VNodeProps[key]
    }
  }
}
```

æ²¡é”™ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå°±å¯ä»¥æ‹¿åˆ°æˆ‘ä»¬ç»‘å®šåˆ°å…ƒç´ ä¸Šçš„äº‹ä»¶

```js
// æ­¤æ—¶çš„keyå°±æ˜¯æˆ‘ä»¬ç»‘å®šçš„äº‹ä»¶åï¼Œæ¯”å¦‚ï¼ŒonClickï¼ŒonChangeç­‰
addEvent(dom, key.toLowerCase(), VNodeProps[key])
```

å› ä¸ºäº‹ä»¶å§”æ‰˜æœºåˆ¶æœ¬èº«æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬å¦èµ·ä¸€ä¸ªæ–‡ä»¶`src/event.js`æ¥ç¼–å†™ç›¸å…³ä»£ç ã€‚

æˆ‘ä»¬å…ˆæ¥ç¼–å†™ addEvent æ–¹æ³•

```js
// æ·»åŠ äº‹ä»¶
export function addEvent(dom, eventName, bindFunction) {
  // å°†äº‹ä»¶ç±»å‹å’Œå›è°ƒå‡½æ•°ç»‘å®šã€‚
  dom.attach = dom.attach || {}
  dom.attach[eventName] = bindFunction
  // äº‹ä»¶å§”æ‰˜æœºåˆ¶çš„æ ¸å¿ƒç‚¹ä¸€ï¼šå°†äº‹ä»¶å§”æ‰˜ç»™document
  if (document[eventName]) return
  document[eventName] = dispatchEvent
}
```

ä¸Šé¢å‡½æ•°åšäº†ä¸¤ä»¶äº‹æƒ…ï¼Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼š

1. å°†äº‹ä»¶ç±»å‹å’Œå›è°ƒå‡½æ•°ç»‘å®šã€‚

   å› ä¸ºæˆ‘ä»¬ç°åœ¨åªæ˜¯åœ¨æ³¨å†Œäº‹ä»¶å’Œå›è°ƒå‡½æ•°ï¼Œè¿˜æ²¡æœ‰åˆ°è°ƒç”¨çš„æ—¶å€™ï¼Œç­‰è°ƒç”¨æ—¶æˆ‘ä»¬éœ€è¦çŸ¥é“å½“å‰å†’æ³¡è¿‡æ¥çš„å¯¹è±¡ï¼Œæœ‰æ²¡æœ‰ç»‘å®šå›è°ƒå‡½æ•°ï¼Œå¦‚æœç»‘å®šæ‰ä¼šæ‰§è¡Œï¼Œå¦åˆ™ä¸æ‰§è¡Œã€‚

2. äº‹ä»¶å§”æ‰˜æœºåˆ¶çš„æ ¸å¿ƒç‚¹ä¸€ï¼šå°†äº‹ä»¶å§”æ‰˜ç»™ document
   1. æˆ‘ä»¬éœ€è¦åœ¨ dispatchEvent æ–¹æ³•ä¸­å¯¹äº‹ä»¶è¿›è¡Œå°è£…
   2. è¿™é‡Œæœ‰ä¸€å±‚éšå¼çš„å‚æ•°ä¼ é€’ï¼Œä¹Ÿå°±æ˜¯åŸç”Ÿäº‹ä»¶å¯¹è±¡

ä¸‹é¢å®ç° dispatchEvent æ–¹æ³•

```js
// nativeEventï¼šåŸå§‹çš„äº‹ä»¶å¯¹è±¡
function dispatchEvent(nativeEvent) {
  // å¼€å¯setStateé˜Ÿåˆ—æ‰¹é‡æ›´æ–°å¼€å…³
  UpdaterQueue.isBatch = true
  // äº‹ä»¶å§”æ‰˜æœºåˆ¶çš„æ ¸å¿ƒç‚¹äºŒï¼šå±è”½æµè§ˆå™¨ä¹‹é—´çš„å·®å¼‚
  let syntheticEvent = createsyntheticEvent(nativeEvent)
  // ä»æœ€å†…å±‚çš„å­å…ƒç´ ä¸€å±‚å±‚å¾€ä¸Šéå†ï¼Œå¦‚æœå½“å‰éå†çš„å…ƒç´ ä¸­åŒ…å«attachå¯¹è±¡ï¼Œè¯´æ˜è¯¥å…ƒç´ æœ‰äº‹ä»¶ç»‘å®šï¼Œæ‰§è¡Œå®ƒ
  while (target) {
    // è¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå› ä¸ºæœ€ç»ˆæ‰§è¡ŒbindFunctionæ—¶éœ€è¦ç”¨åˆ°
    syntheticEvent.currentTarget = target
    // æ‰¾åˆ°ç»‘å®šçš„äº‹ä»¶ï¼Œæ‰§è¡Œå®ƒ
    const eventName = `on${nativeEvent.type}`
    const bindFunction = target.attach && target.attach[eventName]
    bindFunction && bindFunction(syntheticEvent)
    // å¦‚æœå½“å‰å…ƒç´ é˜»æ­¢äº†å†’æ³¡ï¼Œå°±è·³å‡ºå¾ªç¯
    if (syntheticEvent.isProPagationStopped) {
      break
    }
    target = target.parentNode
  }
  // æ‰§è¡ŒsetStateé˜Ÿåˆ—æ‰¹é‡æ›´æ–°
  flushUpdaterQueue()
}
```

è¿˜è®°å¾—æˆ‘ä»¬åœ¨[ä¸Šä¸€ç¯‡](/frank-blog/2024/01/11/03å¼•å…¥å‡½æ•°ç»„ä»¶ä¸ç±»ç»„ä»¶æå‡æ¸²æŸ“èƒ½åŠ›â€”â€”å®ç°setStateåŠŸèƒ½/)ä¸­ç•™ä¸‹çš„å°å°¾å·´ï¼Œå°±æ˜¯ä½•æ—¶å¼€å§‹ setState çš„æ‰¹é‡æ›´æ–°å—ï¼Ÿæ²¡é”™ï¼Œå°±æ˜¯ç°åœ¨ã€‚å› ä¸ºæˆ‘ä»¬åœ¨ç±»ç»„ä»¶ä¸­è°ƒç”¨ setState çš„æ—¶å€™åªèƒ½æ˜¯åœ¨äº‹ä»¶ç»‘å®šçš„å›è°ƒå‡½æ•°ä¸­ï¼Œæ‰€ä»¥å°±å¯¹åº”åˆ°è¿™é‡Œã€‚

å†å°±æ˜¯æˆ‘ä»¬éœ€è¦åœ¨ createsyntheticEvent æ–¹æ³•ä¸­å±è”½æµè§ˆå™¨ä¹‹é—´çš„å·®å¼‚

```js
function createsyntheticEvent(nativeEvent) {
  // ä¿å­˜åŸç”Ÿäº‹ä»¶å¯¹è±¡çš„keyã€value
  let nativeEventKeyValues = {}
  for (const key in nativeEvent) {
    // æ³¨æ„è¿™é‡Œå¦‚æœå±æ€§å€¼æ˜¯å‡½æ•°çš„è¯ï¼Œå°±éœ€è¦ç»™è¯¥å‡½æ•°ç»‘å®šthisï¼ŒæŒ‡å‘åŸç”Ÿäº‹ä»¶å¯¹è±¡
    nativeEventKeyValues[key] =
      typeof nativeEvent[key] === 'function'
        ? nativeEvent[key].bind(nativeEvent)
        : nativeEvent[key]
  }
  // åˆå¹¶åŸç”Ÿäº‹ä»¶å¯¹è±¡ï¼Œå¹¶æ·»åŠ é¢å¤–çš„å±æ€§æ¥æŠ¹å¹³æµè§ˆå™¨ä¹‹é—´çš„å·®å¼‚
  const syntheticEvent = Object.assign(nativeEventKeyValues, {
    nativeEvent,
    isDefaultPrevented: false, // æ˜¯å¦é˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸º
    isPropPagationStopped: false, // æ˜¯å¦é˜»æ­¢å†’æ³¡
    preventDefault() {
      // æ”¹å†™preventDefaultæ–¹æ³•ï¼ŒæŠ¹å¹³æµè§ˆå™¨å·®å¼‚
      this.isDefaultPrevented = true
      if (this.nativeEvent.preventDefault) {
        this.nativeEvent.isPreventDefault()
      } else {
        this.nativeEvent.returnValue = false
      }
    },
    stopPropagation() {
      // æ”¹å†™stopPropagationæ–¹æ³•ï¼ŒæŠ¹å¹³æµè§ˆå™¨å·®å¼‚
      this.isPropPagationStopped = true
      if (this.nativeEvent.stopPropagation) {
        this.nativeEvent.stopPropagation()
      } else {
        this.nativeEvent.cancelBubble = true
      }
    },
  })
  return syntheticEvent
}
```

### æˆæœæ¼”ç¤º

æˆ‘ä»¬æ”¹å†™ä¸€ä¸‹`src/index.js`ï¼Œä½¿ç”¨ä¸€ä¸‹äº‹ä»¶æ–¹æ³•ï¼Œçœ‹ä¸‹èƒ½å¦æŒ‰ç…§é¢„æœŸæ‰§è¡Œ

```js
// ç±»ç»„ä»¶
class MyComponent extends React.Component {
  counter = 0
  constructor(props) {
    super(props)
    this.state = {
      count: '0',
    }
  }

  updateText(value) {
    this.setState({
      count: value.toString(), // TODOï¼šè¿™é‡Œå¿…é¡»æ˜¯stringï¼Œä¸èƒ½æ˜¯å…¶ä»–ç±»å‹ã€‚æºç é‡Œä¹Ÿæ˜¯è¿™ä¹ˆå®ç°çš„å—ï¼Ÿ
    })
  }

  render() {
    return (
      <div>
        <p
          style={{
            padding: '5px',
            border: '1px solid red',
            color: 'red',
            borderRadius: '4px',
            coursor: 'pointer',
          }}
          onClick={() => this.updateText(++this.counter)}
        >
          count is: {this.state.count}
        </p>
      </div>
    )
  }
}
ReactDOM.render(<MyComponent />, document.getElementById('root'))
```

è¿™é‡Œæˆ‘ä»¬å†™äº†ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæˆ‘ä»¬æ¯æ¬¡ç‚¹å‡»å®ƒéƒ½ä¼š+1ã€‚æˆ‘ä»¬çœ‹ä¸‹æ‰§è¡Œç»“æœ

![](/images/mini-react-04-event-demo.gif)

OKï¼ŒæŒ‰ç…§é¢„æœŸæ‰§è¡Œï¼ŒåŠŸèƒ½å®Œæˆ âœ¨

ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹`src/event.js`å®Œæ•´çš„ä»£ç 

```js
import { UpdaterQueue, flushUpdaterQueue } from './Component'

// æ·»åŠ äº‹ä»¶
export function addEvent(dom, eventName, bindFunction) {
  // å°†äº‹ä»¶ç±»å‹å’Œå›è°ƒå‡½æ•°ç»‘å®š
  dom.attach = dom.attach || {}
  dom.attach[eventName] = bindFunction
  // äº‹ä»¶å§”æ‰˜æœºåˆ¶çš„æ ¸å¿ƒç‚¹ä¸€ï¼šå°†äº‹ä»¶å§”æ‰˜ç»™document
  if (document[eventName]) return
  document[eventName] = dispatchEvent
}

// nativeEventï¼šåŸå§‹çš„äº‹ä»¶å¯¹è±¡
function dispatchEvent(nativeEvent) {
  // å¼€å¯setStateé˜Ÿåˆ—æ‰¹é‡æ›´æ–°å¼€å…³
  UpdaterQueue.isBatch = true
  // äº‹ä»¶å§”æ‰˜æœºåˆ¶çš„æ ¸å¿ƒç‚¹äºŒï¼šå±è”½æµè§ˆå™¨ä¹‹é—´çš„å·®å¼‚
  let syntheticEvent = createsyntheticEvent(nativeEvent)
  let target = nativeEvent.target
  // ä»æœ€å†…å±‚çš„å­å…ƒç´ ä¸€å±‚å±‚å¾€ä¸Šéå†ï¼Œå¦‚æœå½“å‰éå†çš„å…ƒç´ ä¸­åŒ…å«attachå¯¹è±¡ï¼Œè¯´æ˜è¯¥å…ƒç´ æœ‰äº‹ä»¶ç»‘å®šï¼Œæ‰§è¡Œå®ƒ
  while (target) {
    // è¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå› ä¸ºæœ€ç»ˆæ‰§è¡ŒbindFunctionæ—¶éœ€è¦ç”¨åˆ°
    syntheticEvent.currentTarget = target
    // æ‰¾åˆ°ç»‘å®šçš„äº‹ä»¶ï¼Œæ‰§è¡Œå®ƒ
    const eventName = `on${nativeEvent.type}`
    const bindFunction = target.attach && target.attach[eventName]
    bindFunction && bindFunction(syntheticEvent)
    // å¦‚æœå½“å‰å…ƒç´ é˜»æ­¢äº†å†’æ³¡ï¼Œå°±è·³å‡ºå¾ªç¯
    if (syntheticEvent.isProPagationStopped) {
      break
    }
    target = target.parentNode
  }
  // æ‰§è¡ŒsetStateé˜Ÿåˆ—æ‰¹é‡æ›´æ–°
  flushUpdaterQueue()
}

function createsyntheticEvent(nativeEvent) {
  let nativeEventKeyValues = {}
  // è¿™é‡Œç›®å‰çœ‹æ¥ç”¨for...inå’ŒObject.keysç»“æœæ˜¯ä¸€æ ·çš„
  for (const key in nativeEvent) {
    nativeEventKeyValues[key] =
      typeof nativeEvent[key] === 'function'
        ? nativeEvent[key].bind(nativeEvent)
        : nativeEvent[key]
  }
  const syntheticEvent = Object.assign(nativeEventKeyValues, {
    nativeEvent,
    isDefaultPrevented: false,
    isPropPagationStopped: false,
    preventDefault() {
      this.isDefaultPrevented = true
      if (this.nativeEvent.preventDefault) {
        this.nativeEvent.isPreventDefault()
      } else {
        this.nativeEvent.returnValue = false
      }
    },
    stopPropagation() {
      this.isPropPagationStopped = true
      if (this.nativeEvent.stopPropagation) {
        this.nativeEvent.stopPropagation()
      } else {
        this.nativeEvent.cancelBubble = true
      }
    },
  })
  return syntheticEvent
}
```

# ååº

æœ¬ç¯‡å†…å®¹å®Œæˆï¼Œæœ‰é—®é¢˜æ¬¢è¿è®¨è®ºäº¤æµï¼Œæˆ‘ä»¬ä¸‹ä¸€ç¯‡è§ ğŸ‰
