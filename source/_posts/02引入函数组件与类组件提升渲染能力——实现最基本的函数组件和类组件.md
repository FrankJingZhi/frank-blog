---
title: 02å¼•å…¥å‡½æ•°ç»„ä»¶ä¸ç±»ç»„ä»¶æå‡æ¸²æŸ“èƒ½åŠ›â€”â€”å®ç°æœ€åŸºæœ¬çš„å‡½æ•°ç»„ä»¶å’Œç±»ç»„ä»¶
date: 2024-01-11 16:42:43
tags: [React]
categories: [ä»0åˆ°1å®ç°Reactæ ¸å¿ƒåŠŸèƒ½]
---

# å‰è¨€

> è¿™æ˜¯`React`çš„æ·±åº¦å­¦ä¹ ç³»åˆ—çš„ç¬¬äºŒç¯‡ï¼Œè¿™ä¸ªç³»åˆ—æ˜¯é€šè¿‡ä» 0 åˆ° 1 ä¸€æ­¥æ­¥æ‰‹å†™`React`å®ç°è‡ªå·±çš„`mini-react`ï¼Œä»¥æ­¤æ¥è¾¾åˆ°é˜…è¯»æºç ã€å­¦ä¹ æºç çš„ç›®çš„ã€‚

> PSï¼šæœ¬ç« èŠ‚å®ç°çš„å†…å®¹ä¸ºç±»ç»„ä»¶ç‰ˆæœ¬çš„ Reactï¼Œå‡½æ•°ç»„ä»¶ç‰ˆæœ¬çš„ä¼šåœ¨åç»­ç« èŠ‚ä¸­å®ç° ğŸŒŸ

æœ¬ç« èŠ‚æˆ‘ä»¬ä¸»è¦å®ç°å¦‚ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼š

1. å¯¹ä¸Šä¸€ç¯‡ç•™ä¸‹çš„é—®é¢˜è¿›è¡Œè§£ç­”
2. å®ç°å‡½æ•°ç»„ä»¶
3. å®ç°ç±»ç»„ä»¶

# æ­£æ–‡

## å¯¹ä¸Šä¸€ç¯‡ç•™ä¸‹çš„é—®é¢˜è¿›è¡Œè§£ç­”

1. å¦‚æœä¸ç”¨ jsxï¼Œå¦‚ä½•ç”¨ react åœ¨é¡µé¢ä¸Šæ¸²æŸ“"Hello, react!"

   æˆ‘ä»¬ä¸Šä¸€ç¯‡è®²åˆ°ï¼Œjsx ä¼šè¢«æ¸²æŸ“æˆè¿™æ ·çš„å½¢æ€ï¼š
   ![](/images/before-react18.png)

   è¿›è€Œæ‰§è¡Œå¾—åˆ°è™šæ‹Ÿ domã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨è™šæ‹Ÿ dom æ¥æ¸²æŸ“

   ```js
       ReactDOM.render({
           $$typeof: Symbol('react.reactElement'),
           ref: null,
           key: null,
           type: 'div',
           props: {
               children: 'Hello, react!'
           }
       },document.getElementById('root))
   ```

2. ä»æºä»£ç `ReactDOM.render(<div id='box' className='box' style={{color: 'red'}}>hello, react!<span>xxx1</span><span>xxx2</span></div>, document.getElementById('root'))`åˆ°é¡µé¢æ˜¾ç¤ºï¼Œç»å†äº†é‚£äº›å…³é”®æ­¥éª¤

   1. jsx è½¬æ¢æˆè™šæ‹Ÿ dom
   2. å°†è™šæ‹Ÿ dom è½¬æ¢æˆ domï¼ˆåŒ…æ‹¬å¯¹æ ‡ç­¾çš„å¤„ç†ï¼Œå­—ç¬¦ä¸²çš„å¤„ç†ï¼Œæ ‡ç­¾å±æ€§çš„å¤„ç†ï¼‰
   3. å°† dom æŒ‚è½½åˆ°å®¹å™¨ä¸Š

## å®ç°å‡½æ•°ç»„ä»¶

æˆ‘ä»¬æ¥å†™ä¸€ä¸ªç®€å•çš„å‡½æ•°ç»„ä»¶æ¥è§‚å¯Ÿä¸€ä¸‹ï¼Œå®ƒæœ‰ä»€ä¹ˆåŠŸèƒ½ï¼Œä»¥åŠå®ƒåšäº†ä»€ä¹ˆ

```js
// å‡½æ•°ç»„ä»¶
function MyComponent(props) {
  return (
    <div id='box' className='box' style={{ color: 'red' }}>
      hello, react!
      <span>xxx1</span>
      <span>xxx2</span>
    </div>
  )
}
```

å¾ˆæ˜æ˜¾ï¼Œå®ƒæ˜¯æ¥å—äº†ä¸€ä¸ª propsï¼Œè¿”å›äº† jsxã€‚é‚£ä¹Ÿå°±æ˜¯åœ¨æˆ‘ä»¬ä¸Šä¸€ç¯‡çš„åŸºç¡€ä¸Šåšäº†ä¸€å±‚å‡½æ•°çš„å°è£…ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å®ç°å®ƒ

æ‹¿å‡ºæˆ‘ä»¬ä¸Šä¸€ç¯‡å†™çš„ createDOM çš„ä»£ç 

```js
function createDOM(VNode) {
  if (!VNode) return
  const { type, props } = VNode
  let dom
  // åˆ›å»ºå…ƒç´ 
  if (type && VNode.$$typeof === REACT_ELEMENT) {
    dom = document.createElement(type)
  }
  // å¤„ç†å­å…ƒç´ 
  if (props) {
    if (typeof props.children === 'object' && props.children.type) {
      mount(props.children, dom)
    } else if (Array.isArray(props.children)) {
      mountArray(props.children, dom)
    } else if (typeof props.children === 'string') {
      dom.appendChild(document.createTextNode(props.children))
    }
  }
  // å¤„ç†å±æ€§å€¼
  setPropsFromDOM(dom, props)
  return dom
}
```

è¿™é‡Œæˆ‘ä»¬å¤„ç†äº†æ ‡ç­¾å’Œå±æ€§ï¼Œç°åœ¨åˆå¤šäº†ä¸€ä¸ªå‡½æ•°ç»„ä»¶ï¼Œé‚£æˆ‘ä»¬ç»§ç»­å¯¹å‡½æ•°ç»„ä»¶å¤„ç†å³å¯

```js
function createDOM(VNode) {
  if (!VNode) return
  const { type, props } = VNode
  let dom
  // å¤„ç†å‡½æ•°å¼ç»„ä»¶
  if (typeof type === 'function' && VNode.$$typeof === REACT_ELEMENT) {
    return getFunctionalDOM(VNode)
  }
  // åˆ›å»ºå…ƒç´ 
  if (type && VNode.$$typeof === REACT_ELEMENT) {
    dom = document.createElement(type)
  }
  // å¤„ç†å­å…ƒç´ 
  if (props) {
    if (typeof props.children === 'object' && props.children.type) {
      mount(props.children, dom)
    } else if (Array.isArray(props.children)) {
      mountArray(props.children, dom)
    } else if (typeof props.children === 'string') {
      dom.appendChild(document.createTextNode(props.children))
    }
  }
  // å¤„ç†å±æ€§å€¼
  setPropsFromDOM(dom, props)
  return dom
}
```

å› ä¸ºæˆ‘ä»¬åœ¨ createDOM ä¸­æœ€ç»ˆéœ€è¦ç”¨åˆ°çš„æ˜¯è™šæ‹Ÿ domï¼Œæˆ‘ä»¬å°±è¦æƒ³æ€æ ·èƒ½é€šè¿‡å‡½æ•°ç»„ä»¶å¾—åˆ°è™šæ‹Ÿ domï¼Ÿæ²¡é”™ï¼Œå°±æ˜¯æ‰§è¡Œå®ƒ

```js
// å¤„ç†å‡½æ•°å¼ç»„ä»¶ï¼Œå°†å‚æ•°ä¼ å…¥ï¼Œæ‰§è¡Œè¯¥ç»„ä»¶ï¼Œæœ€ç»ˆè¿”å›è™šæ‹Ÿdom
function getFunctionalDOM(VNode) {
  const { type, props } = VNode
  // æ­¤æ—¶çš„typeå°±æ˜¯å‡½æ•°ç»„ä»¶ï¼Œæˆ‘ä»¬æ‰§è¡Œå®ƒå°±å¯ä»¥å¾—åˆ°jsxï¼Œè¿›è€Œå¾—åˆ°è™šæ‹Ÿdom
  const renderVNode = type(props)
  if (!renderVNode) return null
  return createDOM(renderVNode)
}
```

å¥½ï¼Œæˆ‘ä»¬çœ‹ä¸‹é¡µé¢èƒ½å¦æ­£å¸¸æ¸²æŸ“
![](/images/mini-react-01-reactdom-render.png)

ğŸ‘Œï¼Œå‡½æ•°ç»„ä»¶åŠŸèƒ½æå®š âœ¨

## å®ç°ç±»ç»„ä»¶

ç±»ç»„ä»¶å’Œå‡½æ•°ç»„ä»¶ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯å…ˆå†™ä¸€æ®µç±»ç»„ä»¶çš„ä»£ç çœ‹ä¸‹å®ƒåšäº†ä»€ä¹ˆï¼Œæœ‰ä»€ä¹ˆåŠŸèƒ½

```js
// ç±»ç»„ä»¶
class MyComponent extends React.Component {
  render() {
    return <div>Hello, React!</div>
  }
}
```

ç±»ç»„ä»¶å°±æ˜¯ç»§æ‰¿äº†ä¸€ä¸ª Component çš„ç±»ï¼Œç„¶åå†…éƒ¨æœ‰ä¸€ä¸ª render æ–¹æ³•ï¼Œrender æ–¹æ³•ä¸­è¿”å›äº† jsxã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å®ç° Component ç±»ã€‚å› ä¸º Component ç±»æ˜¯æŒ‚è½½åˆ° React ä¸Šçš„ï¼Œå®ƒåˆæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„ï¼Œç‹¬ç«‹çš„ä¸œè¥¿ï¼Œæ‰€ä»¥æˆ‘ä»¬æ–°å»ºä¸€ä¸ª`src/Component.js`çš„æ–‡ä»¶ï¼Œç„¶åé€šè¿‡`src/react.js`æŠ›å‡ºå»ã€‚

```js
// ç±»ç»„ä»¶
export class Component {
  // æ³¨æ˜è¿™æ˜¯ä¸€ä¸ªç±»ç»„ä»¶ï¼ŒåŒºåˆ«äºå‡½æ•°ç»„ä»¶
  static IS_CLASS_COMPONENT = true
  constructor(props) {
    this.props = props
  }
}
```

å…¶æ¬¡ï¼Œæˆ‘ä»¬åœ¨ createDOM ä¸­å¯¹ç±»ç»„ä»¶åšå¤„ç†ï¼Œ

```js
function createDOM(VNode) {
  if (!VNode) return
  const { type, props } = VNode
  let dom

  // å¤„ç†ç±»ç»„ä»¶ï¼Œæ³¨æ„æˆ‘ä»¬æ·»åŠ äº†IS_CLASS_COMPONENTæ¥åŒºåˆ«äºå‡½æ•°ç»„ä»¶ï¼Œå› ä¸ºç±»ç»„ä»¶æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°
  if (
    typeof type === 'function' &&
    VNode.$$typeof === REACT_ELEMENT &&
    type.IS_CLASS_COMPONENT
  ) {
    return getClassDOM(VNode)
  }
  // å¤„ç†å‡½æ•°å¼ç»„ä»¶
  if (typeof type === 'function' && VNode.$$typeof === REACT_ELEMENT) {
    return getFunctionalDOM(VNode)
  }
  // ...æ­¤å¤„çœç•¥å¤„ç†æ ‡ç­¾å’Œå±æ€§çš„ä»£ç ï¼Œä¹‹å‰å†™äº†å¥½å¤šéäº†
  return dom
}
```

ç„¶åï¼Œæˆ‘ä»¬å°†ç±»ç»„ä»¶å®ä¾‹åŒ–ï¼Œè°ƒç”¨å…¶ä¸­çš„ render æ–¹æ³•ï¼Œæ‹¿åˆ° jsx å³å¯

```js
// å¤„ç†ç±»ç»„ä»¶
function getClassDOM(VNode) {
  const { type, props } = VNode
  // å°†ç±»ç»„ä»¶å®ä¾‹åŒ–
  const instance = new type(props)
  // è°ƒç”¨renderæ–¹æ³•ï¼Œæ‹¿åˆ°jsx
  const renderVNode = instance.render()
  if (!renderVNode) return null
  return createDOM(renderVNode)
}
```

å¥½ï¼Œæˆ‘ä»¬çœ‹ä¸‹é¡µé¢èƒ½å¦æ­£å¸¸æ¸²æŸ“
![](/images/mini-react-02-class-component-render.png)

ğŸ‘Œï¼Œå‡½æ•°ç»„ä»¶åŠŸèƒ½æå®š âœ¨

# åç»­

å¥½äº†ï¼Œåˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬çš„ mini-react å°±å·²ç»æ”¯æŒäº†å‡½æ•°ç»„ä»¶å’Œç±»ç»„ä»¶æœ€åŸºæœ¬çš„èƒ½åŠ›äº†ã€‚ä¸‹ä¸€ç¯‡æˆ‘ä»¬æ¥å®ç° setState çš„åŠŸèƒ½ã€‚å¦‚æœæœ‰é—®é¢˜ä¹Ÿæ¬¢è¿å¤§å®¶è®¨è®ºäº¤æµ ğŸ‰
